#!/bin/bash

function exit_with_error {
    export message=$1
    export code=$2
    echo $message 2>&1
    exit $code
}

export USAGE_ERRMSG='usage: make_latex_file template-name preamble-src body-src'
export USAGE_ERRCODE=1

export TEMPLATEPATH_ERRMSG='Set $TEMPLATEPATH to a list of paths containing your template directories'
export TEMPLATEPATH_ERRCODE=2

export TEMPLATENOTFOUND_ERRMSG='Cannot find template'
export TEMPLATENOTFOUND_ERRCODE=3

if [ $# -lt 3 ]; then
    exit_with_error "$USAGE_ERRMSG" $USAGE_ERRCODE
fi

if [ -z $TEMPLATEPATH ]; then
    exit_with_error "$TEMPLATEPATH_ERRMSG" $TEMPLATEPATH_ERRCODE
fi


export TEMPLATENAME=$1
export PREAMBLENAME=$2
export BODYSRC=$3

export $final_template_path=""

IFS=":"
for path in $TEMPLATEPATH; do
    export found=0
    export fulldir=`dirname $path`
    for template in `ls -1 $fulldir/$path`; do
        if [ $template == $TEMPLATENAME]; then
            found=1
            break
        fi
    done
    if [ $FOUND -eq 1 ]; then
        final_template_path="$fulldir/$path"
        break
    fi
done

if [ -z $final_template_path ]; then
    exit_with_error "$TEMPLATENOTFOUND_ERRMSG" $TEMPLATENOTFOUND_ERRCODE
fi

